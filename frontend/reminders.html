<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Reminders • PIM</title>
  <style>
    :root{--bg:#0a0a0a;--panel:#111;--card:#161616;--ink:#f5f5f5;--muted:#bdbdbd;--border:#2a2a2a;--accent:#fff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:900px;margin:24px auto;padding:0 16px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .back{color:var(--muted);text-decoration:none;border:1px solid var(--border);padding:6px 10px;border-radius:8px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:16px}
    .row{display:grid;grid-template-columns:2fr 1fr 120px;gap:10px}
    input,button{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#141414;color:var(--ink)}
    button{background:var(--accent);color:#000;border:1px solid rgba(255,255,255,.35);font-weight:700;cursor:pointer}
    .list{margin-top:16px}
    .item{display:flex;justify-content:space-between;align-items:center;background:#1b1b1b;border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:8px}
    .meta{color:var(--muted);font-size:12px}
    .danger{background:#2a1515;border-color:#4a2a2a;color:#ffbdbd}
    .ok{color:#a7ffcf;font-size:13px;margin-top:10px;min-height:18px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="back" href="dashboard.html">← Back</a>
      <h2>Reminders</h2>
    </div>

    <div class="card">
      <div class="row">
        <input id="text" placeholder="Reminder text (e.g., Call Alice)"/>
        <input id="when" type="datetime-local"/>
        <button id="add">Add</button>
      </div>
      <div id="msg" class="ok"></div>
      <div class="list" id="list"></div>
    </div>
  </div>

  <script>
    const username = localStorage.getItem("username") || "guest";
    const sessionId = localStorage.getItem("sessionId");
    if (!sessionId) location.href = "login.html";
    const KEY = `${username}_reminders`;

    const msgEl = document.getElementById("msg");
    const textEl = document.getElementById("text");
    const whenEl = document.getElementById("when");
    const listEl = document.getElementById("list");
    const addBtn = document.getElementById("add");

    const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);

    function load(){ try{return JSON.parse(localStorage.getItem(KEY)||"[]");}catch{return []} }
    function save(items){ localStorage.setItem(KEY, JSON.stringify(items)); }
    function render(){
      const items = load().sort((a,b)=>a.when.localeCompare(b.when));
      listEl.innerHTML = "";
      items.forEach(r=>{
        const row=document.createElement("div");row.className="item";
        const left=document.createElement("div");left.innerHTML=`<div>${r.text}</div><div class="meta">${new Date(r.when).toLocaleString()}</div>`;
        const right=document.createElement("div");
        const del=document.createElement("button"); del.textContent="Delete"; del.className="danger"; del.onclick=()=>{ remove(r.id); };
        right.appendChild(del);
        row.append(left,right);
        listEl.appendChild(row);
      });
    }
    function remove(id){
      const items = load().filter(x=>x.id!==id);
      save(items); render();
    }

    async function ensurePermission(){
      if (!("Notification" in window)) return false;
      if (Notification.permission === "granted") return true;
      if (Notification.permission !== "denied"){
        const res = await Notification.requestPermission();
        return res === "granted";
      }
      return false;
    }

    addBtn.addEventListener("click", async ()=>{
      msgEl.textContent="";
      const text=textEl.value.trim();
      const when=whenEl.value;
      if (!text || !when){ msgEl.textContent="Please provide text and time."; return; }
      const ok = await ensurePermission();
      if (!ok) msgEl.textContent="Notifications are blocked. We'll fallback to alerts.";

      const items = load();
      items.push({ id: uid(), text, when, fired:false });
      save(items);
      textEl.value=""; whenEl.value="";
      render();
      msgEl.textContent="Reminder saved.";
    });

    // background checker
    setInterval(()=>{
      const now = Date.now();
      const items = load();
      let changed=false;
      items.forEach(r=>{
        if (!r.fired){
          const t = new Date(r.when).getTime();
          if (t && now>=t){
            r.fired = true; changed=true;
            if ("Notification" in window && Notification.permission==="granted"){
              new Notification("Reminder", { body: r.text });
            }else{
              alert("Reminder: " + r.text);
            }
          }
        }
      });
      if (changed){ save(items); render(); }
    }, 15000); // check every 15s

    // init
    (async ()=>{ await ensurePermission(); render(); })();
  </script>
</body>
</html>