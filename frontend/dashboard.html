<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard • PIM</title>
  <style>
    :root {
      --bg:#0a0a0a; --sidebar-bg:#111; --card-bg:#1a1a1a;
      --text:#f5f5f5; --muted:#bdbdbd; --accent:#fff;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{height:100vh;display:flex;background:var(--bg);color:var(--text);font:15px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    /* Sidebar */
    .sidebar{width:260px;background:var(--sidebar-bg);padding:20px;display:flex;flex-direction:column;justify-content:space-between}
    .folders{margin-top:20px}
    .folder{padding:8px 10px;border-radius:8px;background:#222;margin-bottom:8px;cursor:pointer}
    .folder:hover{background:#333}
    .subfolder{margin-left:20px}
    .add-folder-btn{margin-top:12px;padding:8px;background:var(--accent);color:var(--bg);border:none;border-radius:6px;cursor:pointer;font-weight:bold}
    .profile{display:flex;flex-direction:column;align-items:center;margin-top:auto}
    .profile img{width:40px;height:40px;border-radius:50%;margin-bottom:10px}
    .logout{margin-top:10px;padding:12px 16px;width:100%;background:#222;color:var(--text);border:none;border-radius:8px;cursor:pointer;font-size:15px;font-weight:bold;transition:background .2s,transform .1s}
    .logout:hover{background:#333;transform:scale(1.05)}
    /* Main */
    .main{flex:1;padding:20px;display:flex;flex-direction:column}
    .topbar{display:flex;justify-content:space-between;align-items:center}
    .search{padding:8px 10px;border-radius:8px;border:none;background:#1f1f1f;color:var(--text);width:260px}
    .widgets{margin-top:20px;display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .widget{background:var(--card-bg);border-radius:12px;padding:20px;text-align:center;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.4);transition:background .2s}
    .widget:hover{background:#222}
    /* Search results */
    .results{margin-top:20px}
    .note-res{background:#151515;border:1px solid #2d2d2d;border-radius:8px;padding:10px 14px;margin-bottom:10px;cursor:pointer}
    .note-res:hover{background:#222}
    .note-title{font-weight:700}
    .note-snippet{font-size:13px;color:var(--muted);margin-top:4px}
    /* Context menu */
    .context-menu{position:absolute;background:#1f1f1f;border:1px solid #333;border-radius:6px;display:none;flex-direction:column;z-index:1000}
    .context-menu button{background:none;border:none;color:var(--text);padding:8px 14px;text-align:left;cursor:pointer;font-size:14px}
    .context-menu button:hover{background:#333}
  </style>
</head>
<body>
  <div class="sidebar">
    <div>
      <h2>Folders</h2>
      <div class="folders" id="folderList"></div>
      <button class="add-folder-btn" id="addFolderBtn">+ Add Folder</button>
    </div>
    <div class="profile">
      <img src="https://ui-avatars.com/api/?name=User" alt="profile"/>
      <button class="logout" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="main">
    <div class="topbar">
      <h1>Dashboard</h1>
      <input type="text" id="search" class="search" placeholder="Search notes…"/>
    </div>
    <div class="widgets">
      <div class="widget" onclick="location.href='create_note.html'">Create Note</div>
      <div class="widget" onclick="location.href='view_folders.html'">View Folder</div>
      <div class="widget" onclick="location.href='todo.html'">Todo List</div>
      <div class="widget" onclick="location.href='reminders.html'">Reminders</div>
      <div class="widget" onclick="location.href='notes.html'">View Notes</div>
      <div class="widget" onclick="location.href='stats.html'">Stats</div>
    </div>
    <div class="results" id="results"></div>
  </div>

  <div class="context-menu" id="contextMenu">
    <button onclick="addSubfolder()">New Subfolder</button>
    <button onclick="renameFolder()">Rename</button>
    <button onclick="deleteFolder()">Delete</button>
  </div>

  <script>
    const API_BASE = location.hostname.includes("localhost") ? "http://127.0.0.1:8000" : "https://pim-app-final.onrender.com";
    const sessionId = localStorage.getItem("sessionId"); if(!sessionId) location.href="login.html";

    const username = localStorage.getItem("username") || "guest";
    const foldersKey = `${username}_foldersTree`;
    const folderList = document.getElementById("folderList");
    const addFolderBtn = document.getElementById("addFolderBtn");
    const contextMenu = document.getElementById("contextMenu");
    const searchEl = document.getElementById("search");
    const resultsEl = document.getElementById("results");
    let selectedFolder=null, allNotes=[];

    // Folder helpers
    function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36);}
    function loadFolders(){ return JSON.parse(localStorage.getItem(foldersKey)||"[]"); }
    function saveFolders(tree){ localStorage.setItem(foldersKey,JSON.stringify(tree)); }

    function createFolder(name="Untitled Folder", parent=folderList){
      const div=document.createElement("div");
      div.className="folder"; div.textContent=name; div.draggable=true;
      div.addEventListener("contextmenu",e=>{e.preventDefault();selectedFolder=div;contextMenu.style.display="flex";contextMenu.style.left=e.pageX+"px";contextMenu.style.top=e.pageY+"px";});
      div.addEventListener("dblclick",()=>startRename(div));
      div.addEventListener("dragstart",()=>{selectedFolder=div;div.classList.add("dragging");});
      div.addEventListener("dragend",()=>{div.classList.remove("dragging");saveFolders([...folderList.children].map(f=>({name:f.textContent})));});
      parent.appendChild(div);
    }
    function startRename(folder){
      const old=folder.textContent;
      const input=document.createElement("input");
      input.type="text";input.value=old;folder.textContent="";folder.appendChild(input);input.focus();
      input.addEventListener("keydown",e=>{
        if(e.key==="Enter"){folder.textContent=input.value.trim()||old;saveFolders();}
        else if(e.key==="Escape"){folder.textContent=old;}
      });
      input.addEventListener("blur",()=>{folder.textContent=input.value.trim()||old;saveFolders();});
    }
    addFolderBtn.onclick=()=>createFolder();
    function addSubfolder(){ if(selectedFolder) createFolder("New Subfolder",selectedFolder); contextMenu.style.display="none"; }
    function renameFolder(){ if(selectedFolder) startRename(selectedFolder); contextMenu.style.display="none"; }
    function deleteFolder(){ if(selectedFolder) selectedFolder.remove(); saveFolders(); contextMenu.style.display="none"; }
    document.addEventListener("click",()=>contextMenu.style.display="none");

    // Notes search
    async function loadNotes(){
      const res=await fetch(`${API_BASE}/notes`,{headers:{Authorization:`Bearer ${sessionId}`}});
      const data=await res.json().catch(()=>({}));
      allNotes=res.ok?(data?.data?.notes||[]):[];
    }
    function renderResults(filter){
      resultsEl.innerHTML="";
      if(!filter) return;
      const q=filter.toLowerCase();
      const matches=allNotes.filter(n=>n.title.toLowerCase().includes(q)||(n.content||"").toLowerCase().includes(q));
      matches.forEach(n=>{
        const div=document.createElement("div");div.className="note-res";
        div.innerHTML=`<div class="note-title">${n.title}</div><div class="note-snippet">${(n.content||"").slice(0,80)}...</div>`;
        div.onclick=()=>alert(`${n.title}\n\n${n.content}`);
        resultsEl.appendChild(div);
      });
      if(!matches.length) resultsEl.innerHTML="<div class='note-res'>No matches.</div>";
    }
    searchEl.addEventListener("input",()=>renderResults(searchEl.value.trim()));

    function logout(){localStorage.clear();location.href="login.html";}
    loadNotes();
  </script>
</body>
</html>