<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard • PIM</title>
  <style>
    :root{
      --bg:#0a0a0a;--sidebar:#111;--card:#1a1a1a;--ink:#f5f5f5;--muted:#bdbdbd;--accent:#fff;--border:#2a2a2a;
      --chip:#222;--chip-hover:#2d2d2d;--hl:#2a2a2a;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{height:100vh;display:flex;background:var(--bg);color:var(--ink);font:15px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    /* Sidebar */
    .sidebar{width:270px;background:var(--sidebar);padding:18px;display:flex;flex-direction:column;justify-content:space-between;border-right:1px solid var(--border)}
    .sidebar h2{font-size:16px;margin-bottom:10px}
    .folders{margin-top:6px;user-select:none}
    .folder,.folder .node{padding:8px 10px;border-radius:8px;background:var(--chip);margin-bottom:8px;cursor:pointer;display:flex;align-items:center;gap:8px;border:1px solid transparent}
    .folder:hover,.folder .node:hover{background:var(--chip-hover)}
    .node-children{margin-left:18px;margin-top:6px;border-left:1px dashed var(--hl);padding-left:12px}
    .node.drag-over{outline:1px dashed #777}
    .add-folder-btn{margin-top:12px;padding:9px 10px;background:var(--accent);color:#000;border:1px solid rgba(255,255,255,.35);border-radius:8px;cursor:pointer;font-weight:700;width:100%}
    .profile{display:flex;flex-direction:column;align-items:center;margin-top:auto}
    .profile img{width:40px;height:40px;border-radius:50%;margin-bottom:10px}
    .logout{margin-top:12px;padding:12px 16px;width:100%;background:#222;color:var(--ink);border:1px solid var(--border);border-radius:10px;cursor:pointer;font-size:15px;font-weight:700;transition:background .2s,transform .1s}
    .logout:hover{background:#2a2a2a;transform:scale(1.03)}
    /* Main */
    .main{flex:1;padding:20px;display:flex;flex-direction:column}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .topbar h1{font-size:22px}
    .search{padding:9px 12px;border-radius:10px;border:1px solid var(--border);background:#141414;color:var(--ink);width:300px}
    .widgets{margin-top:16px;display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .widget{background:var(--card);border:1px solid rgba(255,255,255,.18);border-radius:14px;padding:20px;text-align:center;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,.4);transition:background .2s,transform .08s}
    .widget:hover{background:#1f1f1f}
    .widget:active{transform:translateY(1px)}
    .folder-header{display:flex;align-items:center;gap:6px}
    .folder-toggle{width:16px;height:16px;display:inline-grid;place-items:center;border:1px solid var(--border);border-radius:4px;font-size:11px;color:var(--muted)}
    .dim{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="sidebar">
    <div>
      <h2>Folders</h2>
      <div id="folderTree" class="folders"></div>
      <button id="addFolderBtn" class="add-folder-btn">+ Add Folder</button>
    </div>
    <div class="profile">
      <img src="https://ui-avatars.com/api/?name=User" alt="profile" />
      <button class="logout" id="logoutBtn">Logout</button>
    </div>
  </div>

  <div class="main">
    <div class="topbar">
      <h1>Dashboard</h1>
      <input type="text" class="search" placeholder="Search..." id="searchBox"/>
    </div>
    <div class="widgets">
      <div class="widget" onclick="location.href='create_note.html'">Create Note</div>
      <div class="widget" onclick="location.href='view_folders.html'">View Folders</div>
      <div class="widget" onclick="location.href='todo.html'">Todo List</div>
      <div class="widget" onclick="location.href='reminders.html'">Reminders</div>
      <div class="widget" onclick="location.href='notes.html'">View Notes</div>
      <div class="widget" onclick="location.href='stats.html'">Stats</div>
    </div>
    <p class="dim" style="margin-top:10px">Tip: Right-click folders on other pages for more actions (rename, delete, subfolder).</p>
  </div>

  <script>
    // ----- Auth & keys -----
    const username = localStorage.getItem("username") || "guest";
    const sessionId = localStorage.getItem("sessionId");
    if (!sessionId) location.href = "login.html";
    const FOLDERS_KEY = `${username}_foldersTree`;
    const NOTE_FOLDER_KEY = `${username}_noteFolders`;

    const folderTreeEl = document.getElementById("folderTree");
    const addFolderBtn = document.getElementById("addFolderBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    // ----- Folder helpers -----
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

    function loadTree(){
      try{
        const raw = localStorage.getItem(FOLDERS_KEY);
        if (!raw) return [];
        const t = JSON.parse(raw);
        normalizeTree(t);
        return t;
      }catch{ return []; }
    }
    function saveTree(t){ localStorage.setItem(FOLDERS_KEY, JSON.stringify(t)); }

    function normalizeTree(nodes){
      nodes.forEach(n=>{
        if (typeof n === "string"){ // legacy migration
          n = Object.assign(n, { name: n, id: uid(), children: [] });
        }
        if (!n.id) n.id = uid();
        if (!Array.isArray(n.children)) n.children = [];
        normalizeTree(n.children);
      });
    }

    function renderTree(){
      const tree = loadTree();
      folderTreeEl.innerHTML = "";
      tree.forEach(node => folderTreeEl.appendChild(renderNode(node)));
    }

    function renderNode(node){
      const wrap = document.createElement("div");
      wrap.className = "node";
      wrap.draggable = true;

      // header
      const header = document.createElement("div");
      header.className = "folder-header";

      const toggle = document.createElement("span");
      toggle.className = "folder-toggle";
      toggle.textContent = node._collapsed ? "+" : "−";
      toggle.title = "Collapse/Expand";
      toggle.addEventListener("click", (e)=>{
        e.stopPropagation();
        node._collapsed = !node._collapsed;
        saveNodeChange(node.id, n => n._collapsed = node._collapsed);
        renderTree();
      });

      const nameEl = document.createElement("span");
      nameEl.textContent = node.name;

      header.appendChild(toggle);
      header.appendChild(nameEl);
      wrap.appendChild(header);

      // children
      const childrenEl = document.createElement("div");
      childrenEl.className = "node-children";
      if (node._collapsed) childrenEl.style.display = "none";
      node.children.forEach(child => childrenEl.appendChild(renderNode(child)));
      wrap.appendChild(childrenEl);

      // drag & drop
      wrap.addEventListener("dragstart", e=>{
        e.dataTransfer.setData("text/plain", node.id);
        setTimeout(()=>wrap.classList.add("dragging"),0);
      });
      wrap.addEventListener("dragend", ()=>wrap.classList.remove("dragging"));
      wrap.addEventListener("dragover", e=>{e.preventDefault(); wrap.classList.add("drag-over");});
      wrap.addEventListener("dragleave", ()=>wrap.classList.remove("drag-over"));
      wrap.addEventListener("drop", e=>{
        e.preventDefault();
        wrap.classList.remove("drag-over");
        const draggedId = e.dataTransfer.getData("text/plain");
        if (draggedId && draggedId !== node.id){
          moveNode(draggedId, node.id); // make dragged a child of node
          renderTree();
        }
      });

      return wrap;
    }

    function findNodeAndParent(id, nodes, parent=null){
      for (const n of nodes){
        if (n.id === id) return { node:n, parent };
        const r = findNodeAndParent(id, n.children, n);
        if (r) return r;
      }
      return null;
    }

    function moveNode(nodeId, newParentId){
      const tree = loadTree();
      const a = findNodeAndParent(nodeId, tree);
      const b = findNodeAndParent(newParentId, tree);
      if (!a || !b) return;

      // remove from old parent
      const list = a.parent ? a.parent.children : tree;
      const idx = list.findIndex(x=>x.id===nodeId);
      if (idx>=0) list.splice(idx,1);

      // add to new parent
      b.node.children.push(a.node);
      saveTree(tree);
    }

    function saveNodeChange(id, mutator){
      const tree = loadTree();
      const found = findNodeAndParent(id, tree);
      if (found){
        mutator(found.node);
        saveTree(tree);
      }
    }

    // Add top-level folder
    addFolderBtn.addEventListener("click", ()=>{
      const name = prompt("Folder name:");
      if (!name || !name.trim()) return;
      const tree = loadTree();
      tree.push({ id: uid(), name: name.trim(), children: [] });
      saveTree(tree);
      renderTree();
    });

    // Logout
    logoutBtn.addEventListener("click", ()=>{
      localStorage.removeItem("sessionId");
      localStorage.removeItem("username");
      location.href = "login.html";
    });

    // Keep updated if other pages change storage
    window.addEventListener("storage", (e)=>{
      if (e.key === FOLDERS_KEY) renderTree();
    });

    // Initial render
    renderTree();
  </script>
</body>
</html>