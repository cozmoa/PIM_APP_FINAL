<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Notes • PIM</title>
  <style>
    :root{--bg:#0a0a0a;--card:#151515;--ink:#f5f5f5;--muted:#bdbdbd;--border:#2a2a2a;--accent:#fff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .back{color:var(--muted);text-decoration:none;padding:6px 10px;border:1px solid var(--border);border-radius:8px}
    .search{padding:9px 12px;border-radius:10px;border:1px solid var(--border);background:#141414;color:var(--ink);width:300px}
    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:8px}
    .title{font-weight:700}
    .meta{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:8px;margin-top:6px}
    .btn{padding:7px 10px;border:1px solid var(--border);border-radius:8px;background:#1b1b1b;color:var(--ink);cursor:pointer}
    .btn:hover{background:#222}
    .danger{border-color:#733;color:#ffbdbd}
    .select{padding:6px 8px;border-radius:8px;background:#111;border:1px solid var(--border);color:var(--ink)}
    .empty{color:var(--muted);margin-top:20px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <a class="back" href="dashboard.html">← Back</a>
      <input id="search" class="search" placeholder="Search notes…"/>
    </div>

    <div id="cards" class="cards"></div>
    <p id="emptyState" class="empty" style="display:none">No notes yet. Try creating one on the dashboard.</p>
  </div>

  <script>
    const API_BASE = location.hostname.includes("localhost")
      ? "http://127.0.0.1:8000"
      : "https://pim-app-final.onrender.com";
    const username = localStorage.getItem("username") || "guest";
    const sessionId = localStorage.getItem("sessionId");
    if (!sessionId) location.href = "login.html";

    const FOLDERS_KEY = `${username}_foldersTree`;
    const NOTE_FOLDER_KEY = `${username}_noteFolders`;

    const cardsEl = document.getElementById("cards");
    const emptyEl = document.getElementById("emptyState");
    const searchEl = document.getElementById("search");

    let allNotes = [];
    let noteFolderMap = JSON.parse(localStorage.getItem(NOTE_FOLDER_KEY)||"{}");

    // ---------- Folder helpers ----------
    function flatten(tree,prefix=""){
      const out=[];
      tree.forEach(n=>{
        const label=prefix?`${prefix} / ${n.name}`:n.name;
        out.push({id:n.id,label});
        if(n.children?.length) out.push(...flatten(n.children,label));
      });
      return out;
    }
    function loadTree(){ try{return JSON.parse(localStorage.getItem(FOLDERS_KEY)||"[]");}catch{return []} }

    // ---------- Notes ----------
    async function fetchNotes(){
      const res = await fetch(`${API_BASE}/notes`,{headers:{"Authorization":"Bearer "+sessionId}});
      const data = await res.json();
      if(!res.ok) throw new Error(data?.detail||data?.message||"Failed to load notes");
      allNotes = data.notes || [];
      renderNotes();
    }

    function renderNotes(){
      const q=(searchEl.value||"").toLowerCase();
      const list = allNotes.filter(n=>n.title.toLowerCase().includes(q)||(n.preview||"").toLowerCase().includes(q));
      cardsEl.innerHTML="";
      if(list.length===0){emptyEl.style.display="block";return;}else emptyEl.style.display="none";

      const flat=flatten(loadTree());
      const opts=['<option value="">— No folder —</option>',...flat.map(f=>`<option value="${f.id}">${f.label}</option>`)].join("");

      list.forEach(n=>{
        const c=document.createElement("div");c.className="card";
        const title=document.createElement("div");title.className="title";title.textContent=n.title;
        const meta=document.createElement("div");meta.className="meta";meta.textContent=`Edited ${n.modified_at}`;
        const prev=document.createElement("div");prev.textContent=n.preview||"";

        const sel=document.createElement("select");sel.className="select";sel.innerHTML=opts;sel.value=noteFolderMap[n.title]||"";
        sel.onchange=()=>{noteFolderMap[n.title]=sel.value;localStorage.setItem(NOTE_FOLDER_KEY,JSON.stringify(noteFolderMap));};

        const actions=document.createElement("div");actions.className="actions";
        const viewBtn=btn("Open",()=>openNote(n.title));
        const editBtn=btn("Edit",()=>editNote(n.title));
        const delBtn=btn("Delete",()=>deleteNote(n.title),"danger");
        actions.append(viewBtn,editBtn,delBtn);

        c.append(title,meta,prev,sel,actions);
        cardsEl.appendChild(c);
      });
    }

    function btn(label,fn,extra=""){const b=document.createElement("button");b.className="btn "+extra;b.textContent=label;b.onclick=fn;return b;}

    async function openNote(title){
      location.href=`view_note.html?title=${encodeURIComponent(title)}`;
    }
    async function editNote(title){
      const res=await fetch(`${API_BASE}/notes/${encodeURIComponent(title)}`,{headers:{"Authorization":"Bearer "+sessionId}});
      const data=await res.json();if(!res.ok){alert(data?.message||"Failed");return;}
      const current=data.data?.note?.content||"";
      const updated=prompt(`Edit "${title}":`,current);if(updated==null)return;
      const put=await fetch(`${API_BASE}/notes/${encodeURIComponent(title)}`,{method:"PUT",headers:{"Authorization":"Bearer "+sessionId,"Content-Type":"application/json"},body:JSON.stringify({content:updated})});
      const out=await put.json();if(!put.ok){alert(out?.message||"Update failed");return;}
      fetchNotes();
    }
    async function deleteNote(title){
      if(!confirm(`Delete "${title}"?`))return;
      const res=await fetch(`${API_BASE}/notes/${encodeURIComponent(title)}`,{method:"DELETE",headers:{"Authorization":"Bearer "+sessionId}});
      const data=await res.json();if(!res.ok){alert(data?.message||"Delete failed");return;}
      fetchNotes();
      delete noteFolderMap[title];
      localStorage.setItem(NOTE_FOLDER_KEY,JSON.stringify(noteFolderMap));
    }

    searchEl.addEventListener("input",renderNotes);
    fetchNotes().catch(e=>{emptyEl.style.display="block";emptyEl.textContent=e.message||"Failed";});
  </script>
</body>
</html>